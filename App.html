<script>
// ==================== GLOBALE VARIABELEN ====================
let currentData = {
  transactions: [],
  projects: [],
  clients: [],
  invoices: [],
  expenses: [],
  reportData: null
};
let searchTimeout;
let selectedClientData = null;
let selectedExpenseFile = null;

// ==================== INITIALISATIE ====================
document.addEventListener('DOMContentLoaded', function() {
  console.log('VZW Accounting System v5.0 - All 6 bugs fixed!');
  
  setupNavigation();
  setupEventListeners();
  setupClientAutocomplete();
  setupFileUpload();
  testConnection();
  loadDashboard();
  setDefaultDates();
});

// ==================== NAVIGATIE SYSTEEM ====================
function setupNavigation() {
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
      const section = this.getAttribute('data-section');
      showSection(section);
      
      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      this.classList.add('active');
    });
  });
}

function showSection(sectionName) {
  // Hide all sections
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Show target section
  const targetSection = document.getElementById(sectionName);
  if (targetSection) {
    targetSection.classList.add('active');
    
    // Load section-specific data
    switch(sectionName) {
      case 'dashboard':
        loadDashboard();
        break;
      case 'transactions':
        loadTransactions();
        loadProjectsForDropdowns();
        loadNACECodes();
        break;
      case 'projects':
        loadProjects();
        break;
      case 'invoices':
        loadInvoices();
        break;
      case 'expenses':
        loadExpenses();
        loadProjectsForDropdowns();
        // BUG FIX 4: Generate expense number when loading expenses section
        generateExpenseNumberForForm();
        break;
      case 'reports':
        loadProjectsForDropdowns();
        break;
    }
  }
}

// ==================== EVENT LISTENERS ====================
function setupEventListeners() {
  // Transaction form
  const transactionForm = document.getElementById('transactionForm');
  if (transactionForm) {
    transactionForm.addEventListener('submit', handleTransactionSubmit);
  }
  
  // Project form
  const projectForm = document.getElementById('projectForm');
  if (projectForm) {
    projectForm.addEventListener('submit', handleProjectSubmit);
  }
  
  // Invoice form
  const invoiceForm = document.getElementById('invoiceForm');
  if (invoiceForm) {
    invoiceForm.addEventListener('submit', handleInvoiceSubmit);
  }
  
  // Expense form
  const expenseForm = document.getElementById('expenseForm');
  if (expenseForm) {
    expenseForm.addEventListener('submit', handleExpenseSubmit);
  }
  
  // VAT calculation listeners
  const transactionAmount = document.getElementById('transactionAmount');
  const transactionVAT = document.getElementById('transactionVAT');
  if (transactionAmount && transactionVAT) {
    transactionAmount.addEventListener('input', calculateTransactionTotal);
    transactionVAT.addEventListener('change', calculateTransactionTotal);
  }
  
  // Expense VAT calculation
  const expenseAmount = document.getElementById('expenseAmount');
  const expenseVAT = document.getElementById('expenseVAT');
  if (expenseAmount && expenseVAT) {
    expenseAmount.addEventListener('input', calculateExpenseTotal);
    expenseVAT.addEventListener('change', calculateExpenseTotal);
  }
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('invoiceModal');
    if (event.target === modal) {
      closeInvoiceModal();
    }
  }
}

// ==================== CONNECTION TESTING ====================
function testConnection() {
  updateConnectionStatus('testing', 'Verbinding testen...');
  
  google.script.run
    .withSuccessHandler(handleConnectionSuccess)
    .withFailureHandler(handleConnectionError)
    .testConnection();
}

function handleConnectionSuccess(result) {
  if (result.success) {
    updateConnectionStatus('connected', 'Verbonden met Airtable');
    showSuccess('‚úÖ Verbinding met Airtable succesvol getest!');
  } else {
    updateConnectionStatus('disconnected', 'Verbinding mislukt');
    showError('‚ùå Verbindingstest mislukt: ' + result.error);
  }
}

function handleConnectionError(error) {
  updateConnectionStatus('disconnected', 'Verbinding mislukt');
  showError('‚ùå Kan geen verbinding maken met Airtable: ' + error.message);
}

function updateConnectionStatus(status, message) {
  const statusElement = document.getElementById('connectionStatus');
  const indicator = statusElement.querySelector('.status-indicator');
  const text = statusElement.querySelector('span');
  
  // Remove existing classes
  indicator.classList.remove('status-connected', 'status-disconnected');
  
  // Add new class
  if (status === 'connected') {
    indicator.classList.add('status-connected');
  } else {
    indicator.classList.add('status-disconnected');
  }
  
  text.textContent = message;
}

// ==================== CLIENT AUTOCOMPLETE ====================
function setupClientAutocomplete() {
  const searchInput = document.getElementById('clientSearch');
  const resultsDiv = document.getElementById('clientSearchResults');
  
  if (!searchInput || !resultsDiv) return;
  
  // Setup search input event listener
  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Hide results if query too short
    if (query.length < 2) {
      hideSearchResults();
      return;
    }
    
    // Debounce search
    searchTimeout = setTimeout(() => {
      performClientSearch(query);
    }, 300);
  });
  
  // Hide results when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
      hideSearchResults();
    }
  });
  
  // Show results when clicking on search input
  searchInput.addEventListener('focus', function() {
    if (searchInput.value.trim().length >= 2) {
      performClientSearch(searchInput.value.trim());
    }
  });
}

function performClientSearch(query) {
  const resultsDiv = document.getElementById('clientSearchResults');
  
  // Show loading
  resultsDiv.innerHTML = '<div class="loading-search">üîç Zoeken...</div>';
  resultsDiv.style.display = 'block';
  
  // Search clients via Google Apps Script
  google.script.run
    .withSuccessHandler(handleSearchResults)
    .withFailureHandler(handleSearchError)
    .searchClients(query);
}

function handleSearchResults(result) {
  const resultsDiv = document.getElementById('clientSearchResults');
  
  if (!result.success) {
    resultsDiv.innerHTML = '<div class="loading-search">‚ùå Zoekfout: ' + result.error + '</div>';
    return;
  }
  
  if (result.clients.length === 0) {
    resultsDiv.innerHTML = '<div class="loading-search">üö´ Geen klanten gevonden</div>';
    return;
  }
  
  // Build results HTML
  let html = '';
  result.clients.forEach(client => {
    html += `
      <div class="search-result-item" onclick="selectClient('${client.id}', ${JSON.stringify(client).replace(/"/g, '&quot;')})">
        <div class="search-result-company">${client.company || 'Geen bedrijfsnaam'}</div>
        <div class="search-result-contact">üë§ ${client.contact || 'Geen contact'}</div>
        ${client.email ? `<div class="search-result-email">üìß ${client.email}</div>` : ''}
        ${client.city ? `<div class="search-result-email">üèôÔ∏è ${client.city}</div>` : ''}
      </div>
    `;
  });
  
  resultsDiv.innerHTML = html;
}

function handleSearchError(error) {
  const resultsDiv = document.getElementById('clientSearchResults');
  resultsDiv.innerHTML = '<div class="loading-search">‚ùå Fout bij zoeken: ' + error.message + '</div>';
  console.error('Client search error:', error);
}

function selectClient(clientId, clientData) {
  // Store selected client data
  selectedClientData = clientData;
  
  // Fill form fields
  document.getElementById('clientCompany').value = clientData.company || '';
  document.getElementById('contactPerson').value = clientData.contact || '';
  document.getElementById('clientAddress').value = clientData.address || '';
  document.getElementById('clientPostalCode').value = clientData.postalCode || '';
  document.getElementById('clientCity').value = clientData.city || '';
  document.getElementById('clientVatNumber').value = clientData.vatNumber || '';
  document.getElementById('clientEmail').value = clientData.email || '';
  document.getElementById('clientPhone').value = clientData.phone || '';
  
  // Update search input to show selected client
  document.getElementById('clientSearch').value = clientData.company || clientData.contact || '';
  
  // Hide search results
  hideSearchResults();
  
  // Show success message
  showSuccess('‚úÖ Klant geselecteerd: ' + (clientData.company || clientData.contact));
}

function hideSearchResults() {
  const resultsDiv = document.getElementById('clientSearchResults');
  if (resultsDiv) {
    resultsDiv.style.display = 'none';
  }
}

function clearClientForm() {
  // Clear all client fields
  const clientFields = [
    'clientSearch', 'clientCompany', 'contactPerson', 'clientAddress',
    'clientPostalCode', 'clientCity', 'clientVatNumber', 'clientEmail', 'clientPhone'
  ];
  
  clientFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) field.value = '';
  });
  
  selectedClientData = null;
  hideSearchResults();
  
  showInfo('üóëÔ∏è Klantgegevens gewist');
}

function saveNewClientFromInvoice() {
  const clientData = {
    Klantgegevens: document.getElementById('clientCompany').value,
    Contactpersoon: document.getElementById('contactPerson').value,
    Adres: document.getElementById('clientAddress').value,
    Postcode: document.getElementById('clientPostalCode').value,
    Stad: document.getElementById('clientCity').value,
    Land: 'Belgi√´',
    'BTW-nummer': document.getElementById('clientVatNumber').value,
    Email: document.getElementById('clientEmail').value,
    Telefoon: document.getElementById('clientPhone').value
  };
  
  // Basic validation
  if (!clientData.Klantgegevens || !clientData.Contactpersoon) {
    showError('‚ùå Bedrijfsnaam en contactpersoon zijn verplicht');
    return;
  }
  
  showInfo('üíæ Nieuwe klant opslaan...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showSuccess('‚úÖ Nieuwe klant opgeslagen!');
        selectedClientData = {
          id: result.record.id,
          company: clientData.Klantgegevens,
          contact: clientData.Contactpersoon,
          address: clientData.Adres,
          postalCode: clientData.Postcode,
          city: clientData.Stad,
          country: 'Belgi√´',
          vatNumber: clientData['BTW-nummer'],
          email: clientData.Email,
          phone: clientData.Telefoon
        };
      } else {
        showError('‚ùå Klant opslaan mislukt: ' + result.error);
      }
    })
    .withFailureHandler(handleError)
    .createClient(clientData);
}

// ==================== FILE UPLOAD SYSTEM ====================
function setupFileUpload() {
  const fileInput = document.getElementById('expenseFile');
  const dropZone = document.getElementById('fileDropZone');
  
  if (!fileInput || !dropZone) return;
  
  // File input change event
  fileInput.addEventListener('change', handleFileSelect);
  
  // Drag and drop events
  dropZone.addEventListener('dragover', handleDragOver);
  dropZone.addEventListener('dragleave', handleDragLeave);
  dropZone.addEventListener('drop', handleFileDrop);
  
  // Prevent default drag behaviors on document
  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', e => e.preventDefault());
}

function handleDragOver(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileDropZone').classList.add('drag-over');
}

function handleDragLeave(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileDropZone').classList.remove('drag-over');
}

function handleFileDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('fileDropZone').classList.remove('drag-over');
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    processFile(files[0]);
  }
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    processFile(file);
  }
}

function processFile(file) {
  // Validation
  const maxSize = 50 * 1024 * 1024; // 50MB
  if (file.size > maxSize) {
    showError('‚ùå Bestand is te groot. Maximaal 50MB toegestaan.');
    return;
  }
  
  const allowedTypes = [
    'application/pdf',
    'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
    'application/vnd.ms-excel',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'text/plain', 'text/csv'
  ];
  
  if (!allowedTypes.includes(file.type)) {
    showError('‚ùå Bestandstype niet toegestaan. Gebruik PDF, afbeeldingen, Word of Excel bestanden.');
    return;
  }
  
  // Store file
  selectedExpenseFile = file;
  
  // Show preview
  showFilePreview(file);
}

function showFilePreview(file) {
  const dropZone = document.getElementById('fileDropZone');
  const preview = document.getElementById('filePreview');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  
  // Hide drop zone, show preview
  document.getElementById('uploadText').style.display = 'none';
  preview.style.display = 'block';
  
  // Update preview info
  fileName.textContent = file.name;
  fileSize.textContent = formatFileSize(file.size);
  
  showSuccess('‚úÖ Bestand geselecteerd: ' + file.name);
}

function removeFile() {
  selectedExpenseFile = null;
  
  // Reset file input
  document.getElementById('expenseFile').value = '';
  
  // Hide preview, show drop zone
  document.getElementById('filePreview').style.display = 'none';
  document.getElementById('uploadText').style.display = 'block';
  
  showInfo('üóëÔ∏è Bestand verwijderd');
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ==================== DASHBOARD ====================
function loadDashboard() {
  showInfo('üìä Dashboard laden...');
  
  google.script.run
    .withSuccessHandler(updateDashboard)
    .withFailureHandler(handleError)
    .loadDashboardData();
}

function updateDashboard(result) {
  if (result.success) {
    const data = result.data;
    
    // Update statistics
    document.getElementById('totalIncome').textContent = formatCurrency(data.totalIncome);
    document.getElementById('totalExpenses').textContent = formatCurrency(data.totalExpenses);
    document.getElementById('netResult').textContent = formatCurrency(data.netResult);
    document.getElementById('totalVAT').textContent = formatCurrency(data.totalVAT);
    
    // Update recent transactions table
    updateRecentTransactionsTable(data.transactions);
    
    showSuccess('‚úÖ Dashboard bijgewerkt!');
  } else {
    showError('‚ùå Dashboard laden mislukt: ' + result.error);
  }
}

function updateRecentTransactionsTable(transactions) {
  const tbody = document.getElementById('recentTransactionsBody');
  tbody.innerHTML = '';
  
  if (transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Geen transacties gevonden</td></tr>';
    return;
  }
  
  transactions.forEach(transaction => {
    const fields = transaction.fields;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${formatDate(fields.Date)}</td>
      <td><span class="status-badge ${fields.Select === 'Inkomsten' ? 'status-paid' : 'status-pending'}">${fields.Select}</span></td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${fields.Project || 'Algemeen'}</td>
      <td class="text-right ${fields.Select === 'Inkomsten' ? 'text-success' : 'text-error'} font-bold">${formatCurrency(fields.Bedrag)}</td>
    `;
    
    tbody.appendChild(row);
  });
}

// ==================== TRANSACTIONS ====================
function handleTransactionSubmit(e) {
  e.preventDefault();
  
  const transactionData = {
    Date: document.getElementById('transactionDate').value,
    Select: document.getElementById('transactionType').value,
    Beschrijving: document.getElementById('transactionDescription').value,
    Project: document.getElementById('transactionProject').value,
    'NACE Code': document.getElementById('transactionNACE').value,
    Bedrag: parseFloat(document.getElementById('transactionAmount').value),
    'BTW Percentage': parseFloat(document.getElementById('transactionVAT').value)
  };
  
  showInfo('üíæ Transactie opslaan...');
  
  google.script.run
    .withSuccessHandler(handleTransactionSuccess)
    .withFailureHandler(handleError)
    .createTransaction(transactionData);
}

function handleTransactionSuccess(result) {
  if (result.success) {
    showSuccess('‚úÖ Transactie succesvol opgeslagen!');
    resetTransactionForm();
    loadTransactions();
    loadDashboard();
  } else {
    showError('‚ùå Transactie opslaan mislukt: ' + result.error);
  }
}

function loadTransactions() {
  google.script.run
    .withSuccessHandler(updateTransactionsTable)
    .withFailureHandler(handleError)
    .getAllTransactions();
}

function updateTransactionsTable(result) {
  const tbody = document.getElementById('transactionsBody');
  tbody.innerHTML = '';
  
  if (!result.success || result.records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Geen transacties gevonden</td></tr>';
    return;
  }
  
  result.records.forEach(transaction => {
    const fields = transaction.fields;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${formatDate(fields.Date)}</td>
      <td><span class="status-badge ${fields.Select === 'Inkomsten' ? 'status-paid' : 'status-pending'}">${fields.Select}</span></td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${fields.Project || 'Algemeen'}</td>
      <td class="text-right ${fields.Select === 'Inkomsten' ? 'text-success' : 'text-error'} font-bold">${formatCurrency(fields.Bedrag)}</td>
      <td class="text-right">${formatCurrency(fields['BTW Bedrag'] || 0)}</td>
      <td class="text-right font-bold">${formatCurrency(fields.Totaal)}</td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteTransaction('${transaction.id}')">
          üóëÔ∏è
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

function calculateTransactionTotal() {
  const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
  const vatRate = parseFloat(document.getElementById('transactionVAT').value) || 0;
  const vatAmount = amount * (vatRate / 100);
  const total = amount + vatAmount;
  
  document.getElementById('transactionTotal').value = total.toFixed(2);
}

function resetTransactionForm() {
  document.getElementById('transactionForm').reset();
  setDefaultDates();
  calculateTransactionTotal();
}

function deleteTransaction(recordId) {
  if (!confirm('üóëÔ∏è Weet je zeker dat je deze transactie wilt verwijderen?')) {
    return;
  }
  
  showInfo('üóëÔ∏è Transactie verwijderen...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showSuccess('‚úÖ Transactie succesvol verwijderd!');
        loadTransactions();
        loadDashboard();
      } else {
        showError('‚ùå Transactie verwijderen mislukt: ' + result.error);
      }
    })
    .withFailureHandler(handleError)
    .deleteTransaction(recordId);
}

// ==================== PROJECTS ====================
function handleProjectSubmit(e) {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Project aanmaken...';
  
  const projectData = {
    Naam: document.getElementById('projectName').value.trim(),
    Type: document.getElementById('projectType').value.trim(),
    Beschrijving: document.getElementById('projectDescription').value.trim()
  };
  
  if (!projectData.Naam || projectData.Naam.length < 2) {
    showError('‚ùå Projectnaam moet minimaal 2 karakters lang zijn');
    resetSubmitButton(submitBtn, originalText);
    return;
  }
  
  if (!projectData.Type) {
    showError('‚ùå Selecteer een projecttype');
    resetSubmitButton(submitBtn, originalText);
    return;
  }
  
  showInfo('üíæ Project aanmaken... Dit kan even duren.');
  
  const timeoutId = setTimeout(() => {
    showError('‚è∞ Project aanmaken duurt langer dan verwacht. Controleer je internetverbinding.');
  }, 15000);
  
  google.script.run
    .withSuccessHandler(function(result) {
      clearTimeout(timeoutId);
      resetSubmitButton(submitBtn, originalText);
      
      if (result.success) {
        showSuccess('‚úÖ Project succesvol aangemaakt!');
        document.getElementById('projectForm').reset();
        loadProjects();
        loadProjectsForDropdowns();
      } else {
        if (result.error.includes('502') || result.error.includes('timeout')) {
          showError('üîÑ Server tijdelijk overbelast. Probeer het over 30 seconden opnieuw.');
        } else {
          showError('‚ùå Project aanmaken mislukt: ' + result.error);
        }
      }
    })
    .withFailureHandler(function(error) {
      clearTimeout(timeoutId);
      resetSubmitButton(submitBtn, originalText);
      
      console.error('Project creation failed:', error);
      
      if (error.message.includes('502') || error.message.includes('NetworkError')) {
        showError('üîÑ Verbindingsprobleem met de server. Wacht 30 seconden en probeer opnieuw.');
      } else if (error.message.includes('timeout')) {
        showError('‚è∞ Verzoek duurde te lang. Probeer opnieuw met een stabielere internetverbinding.');
      } else {
        showError('‚ùå Onverwachte fout bij project aanmaken: ' + error.message);
      }
    })
    .createProject(projectData);
}

function loadProjects() {
  google.script.run
    .withSuccessHandler(updateProjectsTable)
    .withFailureHandler(handleError)
    .getAllProjects();
}

function updateProjectsTable(result) {
  const tbody = document.getElementById('projectsBody');
  tbody.innerHTML = '';
  
  if (!result.success || result.records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Geen projecten gevonden</td></tr>';
    return;
  }
  
  result.records.forEach(project => {
    const fields = project.fields;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${fields.Naam}</td>
      <td><span class="status-badge status-paid">${fields.Type}</span></td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${formatDate(fields.Aangemaakt)}</td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteProject('${project.id}')">
          üóëÔ∏è
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

function deleteProject(recordId) {
  if (!confirm('üóëÔ∏è Weet je zeker dat je dit project wilt verwijderen?')) {
    return;
  }
  
  showInfo('üóëÔ∏è Project verwijderen...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showSuccess('‚úÖ Project succesvol verwijderd!');
        loadProjects();
        loadProjectsForDropdowns();
      } else {
        showError('‚ùå Project verwijderen mislukt: ' + result.error);
      }
    })
    .withFailureHandler(handleError)
    .deleteProject(recordId);
}

function loadProjectsForDropdowns() {
  google.script.run
    .withSuccessHandler(populateProjectDropdowns)
    .withFailureHandler(function(error) {
      console.error('Failed to load projects for dropdowns:', error);
    })
    .getAllProjects();
}

function populateProjectDropdowns(result) {
  if (!result.success) return;
  
  const dropdowns = [
    document.getElementById('transactionProject'),
    document.getElementById('expenseProject'),
    document.getElementById('reportProject')
  ];
  
  dropdowns.forEach(dropdown => {
    if (!dropdown) return;
    
    // Clear existing options except the first one
    const firstOption = dropdown.querySelector('option');
    dropdown.innerHTML = '';
    if (firstOption) {
      dropdown.appendChild(firstOption);
    }
    
    // Add project options
    result.records.forEach(project => {
      const option = document.createElement('option');
      option.value = project.fields.Naam;
      option.textContent = project.fields.Naam;
      dropdown.appendChild(option);
    });
  });
}

// ==================== INVOICE MANAGEMENT ====================
function openInvoiceModal() {
  document.getElementById('invoiceModal').style.display = 'block';
  
  // BUG FIX 2: Don't auto-generate number on modal open
  // Instead, only generate if field is empty
  const invoiceNumberField = document.getElementById('invoiceNumber');
  if (!invoiceNumberField.value || invoiceNumberField.value.trim() === '') {
    generateInvoiceNumber();
  }
  
  // Clear previous data
  selectedClientData = null;
  clearClientForm();
  
  // Set default dates
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('invoiceDate').value = today;
  
  // Auto-set project period to current month
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  const projectPeriodField = document.getElementById('invoiceProjectPeriod');
  if (projectPeriodField) {
    projectPeriodField.value = `${startOfMonth.toLocaleDateString('nl-BE')} - ${endOfMonth.toLocaleDateString('nl-BE')}`;
  }
}

function closeInvoiceModal() {
  document.getElementById('invoiceModal').style.display = 'none';
}

// BUG FIX 1 & 2: Generate invoice number from Airtable
function generateInvoiceNumber() {
  showInfo('üìù Factuurnummer ophalen van Airtable...');
  
  google.script.run
    .withSuccessHandler(function(invoiceNumber) {
      document.getElementById('invoiceNumber').value = invoiceNumber;
      showSuccess('‚úÖ Factuurnummer: ' + invoiceNumber);
    })
    .withFailureHandler(function(error) {
      console.error('Failed to generate invoice number:', error);
      const fallbackNumber = `${new Date().getFullYear()}-${Date.now().toString().slice(-3)}`;
      document.getElementById('invoiceNumber').value = fallbackNumber;
      showWarning('‚ö†Ô∏è Kon geen nummer van Airtable krijgen, tijdelijk nummer gebruikt');
    })
    .generateInvoiceNumber();
}

function addInvoiceService() {
  const container = document.getElementById('invoiceServicesContainer');
  const serviceCount = container.children.length + 1;
  
  const serviceDiv = document.createElement('div');
  serviceDiv.className = 'invoice-service-item';
  serviceDiv.innerHTML = `
    <button type="button" class="remove-service" onclick="removeInvoiceService(this)">√ó</button>
    <h5>üõ†Ô∏è Dienst ${serviceCount}</h5>
    <div class="form-group">
      <label class="form-label">üìù Omschrijving *</label>
      <input type="text" class="form-control service-description" required>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">üî¢ Aantal</label>
        <input type="number" class="form-control service-quantity" min="1" value="1" required>
      </div>
      <div class="form-group">
        <label class="form-label">üí∞ Prijs (‚Ç¨)</label>
        <input type="number" class="form-control service-price" step="0.01" min="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">üìä BTW</label>
        <select class="form-control service-vat">
          <option value="0">0% (Vrijgesteld)</option>
          <option value="21" selected>21%</option>
          <option value="6">6%</option>
          <option value="12">12%</option>
        </select>
      </div>
    </div>
  `;
  
  container.appendChild(serviceDiv);
}

function removeInvoiceService(button) {
  const serviceItem = button.closest('.invoice-service-item');
  serviceItem.remove();
  
  // Renumber remaining services
  const container = document.getElementById('invoiceServicesContainer');
  const services = container.querySelectorAll('.invoice-service-item');
  services.forEach((service, index) => {
    const header = service.querySelector('h5');
    header.textContent = `üõ†Ô∏è Dienst ${index + 1}`;
  });
}

// BUG FIX 3: Enhanced invoice submit with PDF generation
function handleInvoiceSubmit(e) {
  e.preventDefault();
  
  // Disable form during processing
  const form = document.getElementById('invoiceForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Factuur maken...';
  
  const services = [];
  document.querySelectorAll('.invoice-service-item').forEach(item => {
    const description = item.querySelector('.service-description').value.trim();
    const quantity = parseInt(item.querySelector('.service-quantity').value);
    const unitPrice = parseFloat(item.querySelector('.service-price').value);
    const vat = item.querySelector('.service-vat').value;
    
    if (description && quantity && unitPrice) {
      services.push({
        description: description,
        quantity: quantity,
        unitPrice: unitPrice,
        vat: vat
      });
    }
  });
  
  // Validation
  if (services.length === 0) {
    showError('‚ùå Voeg minimaal √©√©n dienst toe');
    resetSubmitButton(submitBtn, originalText);
    return;
  }
  
  const invoiceData = {
    invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
    invoiceDate: formatDateForInvoice(document.getElementById('invoiceDate').value),
    clientCompany: document.getElementById('clientCompany').value.trim(),
    contactPerson: document.getElementById('contactPerson').value.trim(),
    address: document.getElementById('clientAddress').value.trim(),
    postalCode: document.getElementById('clientPostalCode').value.trim(),
    city: document.getElementById('clientCity').value.trim(),
    country: 'Belgi√´',
    vatNumber: document.getElementById('clientVatNumber').value.trim(),
    projectName: document.getElementById('invoiceProject').value.trim(),
    projectPeriod: document.getElementById('invoiceProjectPeriod').value.trim(),
    accountManager: document.getElementById('invoiceAccountManager').value.trim(),
    services: services,
    discount: 0
  };
  
  // Enhanced validation
  if (!invoiceData.clientCompany || !invoiceData.contactPerson || !invoiceData.projectName) {
    showError('‚ùå Bedrijf, contactpersoon en projectnaam zijn verplicht');
    resetSubmitButton(submitBtn, originalText);
    return;
  }
  
  if (!invoiceData.invoiceNumber || !invoiceData.invoiceNumber.match(/^\d{4}-\d{3}$/)) {
    showError('‚ùå Factuurnummer moet formaat YYYY-XXX hebben (bijv. 2025-009)');
    resetSubmitButton(submitBtn, originalText);
    return;
  }
  
  // Save new client if needed
  if (!selectedClientData && invoiceData.clientCompany) {
    saveNewClientFromInvoice();
  }
  
  showInfo('üìÑ Factuur aanmaken en PDF genereren... Dit kan 30-60 seconden duren.');
  
  // Extended timeout for PDF generation
  const timeoutId = setTimeout(() => {
    showError('‚è∞ PDF generatie duurt langer dan verwacht. Dit kan bij grote facturen voorkomen.');
  }, 30000);
  
  google.script.run
    .withSuccessHandler(function(result) {
      clearTimeout(timeoutId);
      resetSubmitButton(submitBtn, originalText);
      
      if (result.success) {
        let message = `‚úÖ Factuur ${result.invoiceNumber} succesvol aangemaakt!`;
        
        if (result.pdfResult && result.pdfResult.success) {
          message += `<br>üìÑ PDF succesvol gegenereerd en opgeslagen`;
          
          // Show PDF download section
          document.getElementById('invoicePdfSection').style.display = 'block';
          document.getElementById('invoicePdfLink').href = result.pdfResult.downloadUrl;
          document.getElementById('invoicePdfLink').textContent = `üìÑ Download ${result.pdfResult.fileName}`;
          
          showSuccess(`${message}<br>üìÅ Opgeslagen in: ${result.pdfResult.folderName}`);
        } else if (result.pdfResult) {
          showError(`‚ö†Ô∏è Factuur aangemaakt maar PDF fout: ${result.pdfResult.error}<br>Je kunt de factuur handmatig exporteren via de facturen lijst.`);
        } else {
          showSuccess(message);
        }
        
        closeInvoiceModal();
        loadInvoices();
        loadDashboard();
      } else {
        showError('‚ùå Factuur aanmaken mislukt: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      clearTimeout(timeoutId);
      resetSubmitButton(submitBtn, originalText);
      
      console.error('Invoice creation failed:', error);
      
      if (error.message.includes('PDF') || error.message.includes('Document')) {
        showError('üìÑ Factuur data opgeslagen, maar PDF generatie mislukt. Probeer later opnieuw via de facturen lijst.');
      } else if (error.message.includes('Drive') || error.message.includes('folder')) {
        showError('üìÅ Probleem met Google Drive toegang. Controleer de folder rechten.');
      } else if (error.message.includes('timeout') || error.message.includes('502')) {
        showError('‚è∞ Server tijdelijk overbelast. Probeer het over een minuut opnieuw.');
      } else {
        showError('‚ùå Factuur aanmaken mislukt: ' + error.message);
      }
    })
    .createInvoice(invoiceData);
}

function loadInvoices() {
  google.script.run
    .withSuccessHandler(updateInvoicesTable)
    .withFailureHandler(handleError)
    .getAllTransactions();
}

function updateInvoicesTable(result) {
  const tbody = document.getElementById('invoicesBody');
  tbody.innerHTML = '';
  
  if (!result.success || result.records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Geen facturen gevonden</td></tr>';
    return;
  }
  
  // Filter only invoices (Inkomsten)
  const invoices = result.records.filter(record => record.fields.Select === 'Inkomsten');
  
  if (invoices.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Geen facturen gevonden</td></tr>';
    return;
  }
  
  invoices.forEach(invoice => {
    const fields = invoice.fields;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${formatDate(fields.Date)}</td>
      <td class="font-bold">${fields.Name || '-'}</td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${fields.Project || 'Algemeen'}</td>
      <td class="text-right text-success font-bold">${formatCurrency(fields.Bedrag)}</td>
      <td><span class="status-badge status-paid">${fields.Status || 'Verzonden'}</span></td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteTransaction('${invoice.id}')">
          üóëÔ∏è
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

function formatDateForInvoice(dateString) {
  // Convert YYYY-MM-DD to DD/MM/YYYY
  if (!dateString) return '';
  const parts = dateString.split('-');
  if (parts.length === 3) {
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return dateString;
}

// ==================== EXPENSES MANAGEMENT ====================
function handleExpenseSubmit(e) {
  e.preventDefault();
  
  const formData = {
    date: document.getElementById('expenseDate').value,
    expenseNumber: document.getElementById('expenseNumber').value,
    description: document.getElementById('expenseDescription').value,
    vendor: document.getElementById('expenseVendor').value,
    project: document.getElementById('expenseProject').value,
    category: document.getElementById('expenseCategory').value,
    paymentMethod: document.getElementById('expensePaymentMethod').value,
    amount: parseFloat(document.getElementById('expenseAmount').value),
    vatPercentage: parseFloat(document.getElementById('expenseVAT').value)
  };
  
  // Validation
  if (!formData.description || !formData.vendor || !formData.category || !formData.amount) {
    showError('‚ùå Vul alle verplichte velden in');
    return;
  }
  
  if (!formData.expenseNumber || formData.expenseNumber.trim() === '') {
    generateExpenseNumberForForm();
    return;
  }
  
  showInfo('üíæ Uitgave opslaan...');
  
  // Disable submit button
  const submitBtn = document.getElementById('saveExpenseBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Opslaan...';
  
  // Check if file is selected
  if (selectedExpenseFile) {
    uploadExpenseWithFile(formData, selectedExpenseFile);
  } else {
    // Create expense without file
    google.script.run
      .withSuccessHandler(handleExpenseSuccess)
      .withFailureHandler(handleExpenseError)
      .createExpense(formData);
  }
}

function uploadExpenseWithFile(expenseData, file) {
  // Show upload progress
  showUploadProgress(true);
  
  // Convert file to base64 for Google Apps Script
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Data = e.target.result.split(',')[1]; // Remove data:mime;base64, prefix
    
    // Create blob object for Google Apps Script
    const fileBlob = {
      data: base64Data,
      name: file.name,
      mimeType: file.type,
      size: file.size
    };
    
    google.script.run
      .withSuccessHandler(handleExpenseWithFileSuccess)
      .withFailureHandler(handleExpenseError)
      .createExpenseWithFile(expenseData, fileBlob, file.name);
  };
  
  reader.onerror = function() {
    showError('‚ùå Fout bij lezen van bestand');
    resetSubmitButton();
  };
  
  reader.readAsDataURL(file);
}

function showUploadProgress(show) {
  const progressDiv = document.getElementById('uploadProgress');
  if (show) {
    progressDiv.style.display = 'block';
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      document.getElementById('progressFill').style.width = progress + '%';
    }, 200);
    
    // Store interval ID to clear later
    progressDiv.dataset.interval = interval;
  } else {
    progressDiv.style.display = 'none';
    if (progressDiv.dataset.interval) {
      clearInterval(parseInt(progressDiv.dataset.interval));
    }
  }
}

function handleExpenseWithFileSuccess(result) {
  resetSubmitButton();
  showUploadProgress(false);
  
  if (result.success) {
    if (result.fileResult) {
      showSuccess(`‚úÖ Uitgave en bestand succesvol opgeslagen!<br>
        üìé Bestand: <a href="${result.fileResult.viewUrl}" target="_blank">${result.fileResult.fileName}</a>`);
    } else {
      showSuccess('‚úÖ Uitgave succesvol opgeslagen!');
    }
    
    resetExpenseForm();
    loadExpenses();
    loadDashboard();
  } else {
    showError('‚ùå Opslaan mislukt: ' + result.error);
  }
}

function handleExpenseSuccess(result) {
  resetSubmitButton();
  
  if (result.success) {
    showSuccess('‚úÖ Uitgave succesvol opgeslagen!');
    resetExpenseForm();
    loadExpenses();
    loadDashboard();
  } else {
    showError('‚ùå Opslaan mislukt: ' + result.error);
  }
}

function handleExpenseError(error) {
  resetSubmitButton();
  showUploadProgress(false);
  showError('‚ùå Fout bij opslaan: ' + error.message);
}

function resetSubmitButton(button, originalText) {
  if (button) {
    button.disabled = false;
    button.textContent = originalText;
  } else {
    // Reset expense submit button if no button provided
    const submitBtn = document.getElementById('saveExpenseBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = '‚úÖ Uitgave Opslaan';
    }
  }
}

function resetExpenseForm() {
  document.getElementById('expenseForm').reset();
  setDefaultDates();
  calculateExpenseTotal();
  removeFile();
  generateExpenseNumberForForm();
}

// BUG FIX 4: Generate expense number from Airtable
function generateExpenseNumberForForm() {
  showInfo('üìù Uitgavenummer ophalen van Airtable...');
  
  google.script.run
    .withSuccessHandler(function(expenseNumber) {
      document.getElementById('expenseNumber').value = expenseNumber;
      showSuccess('‚úÖ Uitgavenummer: ' + expenseNumber);
    })
    .withFailureHandler(function(error) {
      console.error('Failed to generate expense number:', error);
      const fallbackNumber = `UIT-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`;
      document.getElementById('expenseNumber').value = fallbackNumber;
      showWarning('‚ö†Ô∏è Kon geen nummer van Airtable krijgen, tijdelijk nummer gebruikt');
    })
    .generateExpenseNumber();
}

function calculateExpenseTotal() {
  const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
  const vatRate = parseFloat(document.getElementById('expenseVAT').value) || 0;
  const vatAmount = amount * (vatRate / 100);
  const total = amount + vatAmount;
  
  document.getElementById('expenseTotal').value = total.toFixed(2);
}

function loadExpenses() {
  google.script.run
    .withSuccessHandler(updateExpensesTable)
    .withFailureHandler(handleError)
    .getAllTransactions();
}

function updateExpensesTable(result) {
  const tbody = document.getElementById('expensesBody');
  tbody.innerHTML = '';
  
  if (!result.success || result.records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Geen uitgaven gevonden</td></tr>';
    return;
  }
  
  // Filter only expenses (Uitgaven)
  const expenses = result.records.filter(record => record.fields.Select === 'Uitgaven');
  
  if (expenses.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Geen uitgaven gevonden</td></tr>';
    return;
  }
  
  expenses.forEach(expense => {
    const fields = expense.fields;
    const row = document.createElement('tr');
    
    // Check for attachment
    let attachmentHtml = '<span class="no-attachment">Geen bijlage</span>';
    if (fields['Bijlage URL']) {
      const fileName = fields['Bijlage Bestandsnaam'] || 'Bijlage';
      attachmentHtml = `<a href="${fields['Bijlage URL']}" target="_blank" class="file-attachment">
        üìé ${fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName}
      </a>`;
    }
    
    row.innerHTML = `
      <td>${formatDate(fields.Date)}</td>
      <td class="font-bold">${fields.Name || '-'}</td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${fields.Leverancier || '-'}</td>
      <td><span class="status-badge status-pending">${fields.Categorie || '-'}</span></td>
      <td class="text-right text-error font-bold">${formatCurrency(fields.Bedrag)}</td>
      <td class="text-right font-bold">${formatCurrency(fields.Totaal)}</td>
      <td>${attachmentHtml}</td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteTransaction('${expense.id}')">
          üóëÔ∏è
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

// ==================== REPORTS ====================
function generateReport() {
  const config = {
    transactionType: document.getElementById('reportType').value,
    project: document.getElementById('reportProject').value,
    periodType: document.getElementById('reportPeriod').value,
    format: document.getElementById('reportFormat').value
  };
  
  showInfo('üìä Rapport genereren...');
  
  google.script.run
    .withSuccessHandler(handleReportSuccess)
    .withFailureHandler(handleError)
    .generateReport(config);
}

function handleReportSuccess(result) {
  if (result.success) {
    currentData.reportData = result.data;
    displayReportResults(result.data);
    document.getElementById('exportPdfBtn').style.display = 'inline-flex';
    showSuccess('‚úÖ Rapport gegenereerd!');
  } else {
    showError('‚ùå Rapport genereren mislukt: ' + result.error);
  }
}

function displayReportResults(data) {
  const resultsDiv = document.getElementById('reportResults');
  const summaryDiv = document.getElementById('reportSummary');
  const tableBody = document.getElementById('reportResultsBody');
  
  // Show results section
  resultsDiv.style.display = 'block';
  
  // Populate summary cards
  summaryDiv.innerHTML = `
    <div class="summary-item">
      <div class="summary-value text-success">${formatCurrency(data.summary.totalIncome)}</div>
      <div class="summary-label">Totale Inkomsten</div>
    </div>
    <div class="summary-item">
      <div class="summary-value text-error">${formatCurrency(data.summary.totalExpenses)}</div>
      <div class="summary-label">Totale Uitgaven</div>
    </div>
    <div class="summary-item">
      <div class="summary-value ${data.summary.netResult >= 0 ? 'text-success' : 'text-error'}">${formatCurrency(data.summary.netResult)}</div>
      <div class="summary-label">Netto Resultaat</div>
    </div>
    <div class="summary-item">
      <div class="summary-value">${data.summary.transactionCount}</div>
      <div class="summary-label">Transacties</div>
    </div>
  `;
  
  // Populate detailed table
  tableBody.innerHTML = '';
  
  if (data.transactions.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Geen transacties gevonden voor de geselecteerde criteria</td></tr>';
    return;
  }
  
  data.transactions.forEach(transaction => {
    const fields = transaction.fields;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${formatDate(fields.Date)}</td>
      <td><span class="status-badge ${fields.Select === 'Inkomsten' ? 'status-paid' : 'status-pending'}">${fields.Select}</span></td>
      <td>${fields.Name || '-'}</td>
      <td>${fields.Beschrijving || '-'}</td>
      <td>${fields.Project || 'Algemeen'}</td>
      <td class="text-right ${fields.Select === 'Inkomsten' ? 'text-success' : 'text-error'} font-bold">${formatCurrency(fields.Bedrag)}</td>
      <td class="text-right">${formatCurrency(fields['BTW Bedrag'] || 0)}</td>
      <td class="text-right font-bold">${formatCurrency(fields.Totaal)}</td>
    `;
    
    tableBody.appendChild(row);
  });
}

function exportReportPDF() {
  if (!currentData.reportData) {
    showError('‚ùå Geen rapport gegevens beschikbaar');
    return;
  }
  
  showInfo('üìÑ PDF rapport exporteren...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showSuccess(`‚úÖ Rapport PDF succesvol ge√´xporteerd! <a href="${result.downloadUrl}" target="_blank">Download hier</a>`);
        
        // Show PDF download section
        document.getElementById('reportPdfSection').style.display = 'block';
        document.getElementById('reportPdfLink').href = result.downloadUrl;
        document.getElementById('reportPdfLink').textContent = `üìä Download ${result.fileName}`;
      } else {
        showError('‚ùå PDF export mislukt: ' + result.error);
      }
    })
    .withFailureHandler(handleError)
    .exportReportToPDF(currentData.reportData);
}

// ==================== NACE CODES ====================
function loadNACECodes() {
  google.script.run
    .withSuccessHandler(populateNACEDropdown)
    .withFailureHandler(function(error) {
      console.error('Failed to load NACE codes:', error);
    })
    .getCultureNACECodes();
}

function populateNACEDropdown(result) {
  if (!result.success) return;
  
  const dropdown = document.getElementById('transactionNACE');
  if (!dropdown) return;
  
  // Clear existing options except the first one
  const firstOption = dropdown.querySelector('option');
  dropdown.innerHTML = '';
  if (firstOption) {
    dropdown.appendChild(firstOption);
  }
  
  // Add NACE code options
  result.codes.forEach(code => {
    const option = document.createElement('option');
    option.value = code.code;
    option.textContent = `${code.code} - ${code.description}`;
    dropdown.appendChild(option);
  });
}

// ==================== UTILITY FUNCTIONS ====================
function formatCurrency(amount) {
  return new Intl.NumberFormat('nl-BE', {
    style: 'currency',
    currency: 'EUR'
  }).format(amount || 0);
}

function formatDate(dateString) {
  if (!dateString) return '-';
  return new Date(dateString).toLocaleDateString('nl-BE');
}

function setDefaultDates() {
  const today = new Date().toISOString().split('T')[0];
  
  const transactionDate = document.getElementById('transactionDate');
  if (transactionDate && !transactionDate.value) {
    transactionDate.value = today;
  }
  
  const expenseDate = document.getElementById('expenseDate');
  if (expenseDate && !expenseDate.value) {
    expenseDate.value = today;
  }
}

// ==================== ALERT FUNCTIONS ====================
function showSuccess(message) {
  showAlert('successAlert', message);
}

function showError(message) {
  showAlert('errorAlert', message);
}

function showInfo(message) {
  showAlert('infoAlert', message);
}

function showWarning(message) {
  showAlert('warningAlert', message);
}

function showAlert(alertId, message) {
  hideAlerts();
  
  // Map to correct alert types
  const alertMap = {
    'warningAlert': 'infoAlert',
    'successAlert': 'successAlert',
    'errorAlert': 'errorAlert',
    'infoAlert': 'infoAlert'
  };
  
  const mappedId = alertMap[alertId] || 'infoAlert';
  const alert = document.getElementById(mappedId);
  
  if (alert) {
    alert.innerHTML = message;
    alert.classList.add('show');
    
    // Auto-dismiss after longer time for important messages
    const dismissTime = message.length > 100 ? 12000 : 8000;
    setTimeout(() => {
      alert.classList.remove('show');
    }, dismissTime);
  }
}

function hideAlerts() {
  ['successAlert', 'errorAlert', 'infoAlert'].forEach(id => {
    const alert = document.getElementById(id);
    if (alert) {
      alert.classList.remove('show');
    }
  });
}

function handleError(error) {
  console.error('System error:', error);
  showError('‚ùå Systeem fout: ' + (error.message || error));
}

// ==================== SYSTEM FUNCTIONS ====================
function refreshData() {
  showInfo('üîÑ Gegevens verversen...');
  loadDashboard();
  loadProjectsForDropdowns();
  loadNACECodes();
}

// Initialize expense number on page load
document.addEventListener('DOMContentLoaded', function() {
  // Only generate if on expenses page
  const expensesSection = document.getElementById('expenses');
  if (expensesSection && expensesSection.classList.contains('active')) {
    generateExpenseNumberForForm();
  }
});
</script>
